#!/bin/bash

module load compiler/intel/2017_up7 hdf5
export MKL_DEBUG_CPU_TYPE=5
export MKL_CBWR=AVX2
export FI_PROVIDER=mlx
export I_MPI_PIN_DOMAIN=numa
export MPI_exe="mpirun --bind-to l3cache --map-by l3cache -genv I_MPI_FABRICS=shm:tcp -genv I_MPI_PIN_CELL=1 -genv KMP_AFFINITY verbose,granularity=fine,compact -bootstrap lsf"
export QE_bin=/share/opt/apps/qe/7.1/2017/bin
PW_exe="$QE_bin/pw.x < in > ./report"
PW_exe_nk2="$QE_bin/pw.x -nk 2 < in > ./report"
PW_exe_nk4="$QE_bin/pw.x -nk 4 < in > ./report"
PW_exe_nk8="$QE_bin/pw.x -nk 8 < in > ./report"
PW2BGW_exe="$QE_bin/pw2bgw.x -in ./pp.in &> ./report.pp"
PW2WAN_exe="$QE_bin/pw2wannier90.x "
WANNIER_exe=/share/opt/apps/wannier/3.1.0/2018/wannier90.x


#for i in 5 4.5 4.0 3.5 3.0 2.5 2.0 1.7 1.5 1.3 1.0 0.5 0.0
for i in 5.0 4.75 4.5 4.25 4.0 3.75 3.5 3.25 3.0
do
mkdir $i
cd $i
ln -s ../pwscf.mmn .
ln -s ../pwscf.eig .
ln -s ../pwscf.amn .
ln -s ../pwscf.nnkp .

cat >pwscf.win<<!
num_bands         = 48
num_wann          = 24
Begin Projections
Hf: l=-5
C:  l=-3
O:  l=-3
End Projections

NUM_ITER         = 300
dis_froz_max = -$i
dis_froz_min = -8.6
#exclude_bands = 12-32

Begin Unit_Cell_Cart
ang
    1.6265767010586571   -2.8173134886413673   0.0000000000000000
    1.6265767010586571   2.8173134886413673   0.0000000000000000
    0.0000000000000000   0.0000000000000000   30.0000000000000036
End Unit_Cell_Cart
Begin Atoms_Frac
Hf 0.3333333333333357 0.6666666666666643 0.4542279768530427
Hf 0.6666666666666643 0.3333333333333357 0.5457720231469587
C 0.0000000000000000 0.0000000000000000 0.5000000000000000
O 0.3333333333333357 0.6666666666666643 0.5767498940406843
O 0.6666666666666643 0.3333333333333357 0.4232501059593156
End Atoms_Frac

begin kpoint_path
G    0.000    0.000    0.000    M    0.000    0.500    0.000
    0.000    0.500    0.000    K    -0.333    0.667    0.000
K    -0.333    0.667    0.000    G    0.000    0.000    0.000
end kpoint_path
bands_num_points 80
bands_plot = .true.

mp_grid= 12 12 1

begin kpoints
  0.00000000  0.00000000  0.00000000       1.000
  0.00000000  0.08333333  0.00000000       1.000
  0.00000000  0.16666667  0.00000000       1.000
  0.00000000  0.25000000  0.00000000       1.000
  0.00000000  0.33333333  0.00000000       1.000
  0.00000000  0.41666667  0.00000000       1.000
  0.00000000  0.50000000  0.00000000       1.000
  0.00000000  0.58333333  0.00000000       1.000
  0.00000000  0.66666667  0.00000000       1.000
  0.00000000  0.75000000  0.00000000       1.000
  0.00000000  0.83333333  0.00000000       1.000
  0.00000000  0.91666667  0.00000000       1.000
  0.08333333  0.00000000  0.00000000       1.000
  0.08333333  0.08333333  0.00000000       1.000
  0.08333333  0.16666667  0.00000000       1.000
  0.08333333  0.25000000  0.00000000       1.000
  0.08333333  0.33333333  0.00000000       1.000
  0.08333333  0.41666667  0.00000000       1.000
  0.08333333  0.50000000  0.00000000       1.000
  0.08333333  0.58333333  0.00000000       1.000
  0.08333333  0.66666667  0.00000000       1.000
  0.08333333  0.75000000  0.00000000       1.000
  0.08333333  0.83333333  0.00000000       1.000
  0.08333333  0.91666667  0.00000000       1.000
  0.16666667  0.00000000  0.00000000       1.000
  0.16666667  0.08333333  0.00000000       1.000
  0.16666667  0.16666667  0.00000000       1.000
  0.16666667  0.25000000  0.00000000       1.000
  0.16666667  0.33333333  0.00000000       1.000
  0.16666667  0.41666667  0.00000000       1.000
  0.16666667  0.50000000  0.00000000       1.000
  0.16666667  0.58333333  0.00000000       1.000
  0.16666667  0.66666667  0.00000000       1.000
  0.16666667  0.75000000  0.00000000       1.000
  0.16666667  0.83333333  0.00000000       1.000
  0.16666667  0.91666667  0.00000000       1.000
  0.25000000  0.00000000  0.00000000       1.000
  0.25000000  0.08333333  0.00000000       1.000
  0.25000000  0.16666667  0.00000000       1.000
  0.25000000  0.25000000  0.00000000       1.000
  0.25000000  0.33333333  0.00000000       1.000
  0.25000000  0.41666667  0.00000000       1.000
  0.25000000  0.50000000  0.00000000       1.000
  0.25000000  0.58333333  0.00000000       1.000
  0.25000000  0.66666667  0.00000000       1.000
  0.25000000  0.75000000  0.00000000       1.000
  0.25000000  0.83333333  0.00000000       1.000
  0.25000000  0.91666667  0.00000000       1.000
  0.33333333  0.00000000  0.00000000       1.000
  0.33333333  0.08333333  0.00000000       1.000
  0.33333333  0.16666667  0.00000000       1.000
  0.33333333  0.25000000  0.00000000       1.000
  0.33333333  0.33333333  0.00000000       1.000
  0.33333333  0.41666667  0.00000000       1.000
  0.33333333  0.50000000  0.00000000       1.000
  0.33333333  0.58333333  0.00000000       1.000
  0.33333333  0.66666667  0.00000000       1.000
  0.33333333  0.75000000  0.00000000       1.000
  0.33333333  0.83333333  0.00000000       1.000
  0.33333333  0.91666667  0.00000000       1.000
  0.41666667  0.00000000  0.00000000       1.000
  0.41666667  0.08333333  0.00000000       1.000
  0.41666667  0.16666667  0.00000000       1.000
  0.41666667  0.25000000  0.00000000       1.000
  0.41666667  0.33333333  0.00000000       1.000
  0.41666667  0.41666667  0.00000000       1.000
  0.41666667  0.50000000  0.00000000       1.000
  0.41666667  0.58333333  0.00000000       1.000
  0.41666667  0.66666667  0.00000000       1.000
  0.41666667  0.75000000  0.00000000       1.000
  0.41666667  0.83333333  0.00000000       1.000
  0.41666667  0.91666667  0.00000000       1.000
  0.50000000  0.00000000  0.00000000       1.000
  0.50000000  0.08333333  0.00000000       1.000
  0.50000000  0.16666667  0.00000000       1.000
  0.50000000  0.25000000  0.00000000       1.000
  0.50000000  0.33333333  0.00000000       1.000
  0.50000000  0.41666667  0.00000000       1.000
  0.50000000  0.50000000  0.00000000       1.000
  0.50000000  0.58333333  0.00000000       1.000
  0.50000000  0.66666667  0.00000000       1.000
  0.50000000  0.75000000  0.00000000       1.000
  0.50000000  0.83333333  0.00000000       1.000
  0.50000000  0.91666667  0.00000000       1.000
  0.58333333  0.00000000  0.00000000       1.000
  0.58333333  0.08333333  0.00000000       1.000
  0.58333333  0.16666667  0.00000000       1.000
  0.58333333  0.25000000  0.00000000       1.000
  0.58333333  0.33333333  0.00000000       1.000
  0.58333333  0.41666667  0.00000000       1.000
  0.58333333  0.50000000  0.00000000       1.000
  0.58333333  0.58333333  0.00000000       1.000
  0.58333333  0.66666667  0.00000000       1.000
  0.58333333  0.75000000  0.00000000       1.000
  0.58333333  0.83333333  0.00000000       1.000
  0.58333333  0.91666667  0.00000000       1.000
  0.66666667  0.00000000  0.00000000       1.000
  0.66666667  0.08333333  0.00000000       1.000
  0.66666667  0.16666667  0.00000000       1.000
  0.66666667  0.25000000  0.00000000       1.000
  0.66666667  0.33333333  0.00000000       1.000
  0.66666667  0.41666667  0.00000000       1.000
  0.66666667  0.50000000  0.00000000       1.000
  0.66666667  0.58333333  0.00000000       1.000
  0.66666667  0.66666667  0.00000000       1.000
  0.66666667  0.75000000  0.00000000       1.000
  0.66666667  0.83333333  0.00000000       1.000
  0.66666667  0.91666667  0.00000000       1.000
  0.75000000  0.00000000  0.00000000       1.000
  0.75000000  0.08333333  0.00000000       1.000
  0.75000000  0.16666667  0.00000000       1.000
  0.75000000  0.25000000  0.00000000       1.000
  0.75000000  0.33333333  0.00000000       1.000
  0.75000000  0.41666667  0.00000000       1.000
  0.75000000  0.50000000  0.00000000       1.000
  0.75000000  0.58333333  0.00000000       1.000
  0.75000000  0.66666667  0.00000000       1.000
  0.75000000  0.75000000  0.00000000       1.000
  0.75000000  0.83333333  0.00000000       1.000
  0.75000000  0.91666667  0.00000000       1.000
  0.83333333  0.00000000  0.00000000       1.000
  0.83333333  0.08333333  0.00000000       1.000
  0.83333333  0.16666667  0.00000000       1.000
  0.83333333  0.25000000  0.00000000       1.000
  0.83333333  0.33333333  0.00000000       1.000
  0.83333333  0.41666667  0.00000000       1.000
  0.83333333  0.50000000  0.00000000       1.000
  0.83333333  0.58333333  0.00000000       1.000
  0.83333333  0.66666667  0.00000000       1.000
  0.83333333  0.75000000  0.00000000       1.000
  0.83333333  0.83333333  0.00000000       1.000
  0.83333333  0.91666667  0.00000000       1.000
  0.91666667  0.00000000  0.00000000       1.000
  0.91666667  0.08333333  0.00000000       1.000
  0.91666667  0.16666667  0.00000000       1.000
  0.91666667  0.25000000  0.00000000       1.000
  0.91666667  0.33333333  0.00000000       1.000
  0.91666667  0.41666667  0.00000000       1.000
  0.91666667  0.50000000  0.00000000       1.000
  0.91666667  0.58333333  0.00000000       1.000
  0.91666667  0.66666667  0.00000000       1.000
  0.91666667  0.75000000  0.00000000       1.000
  0.91666667  0.83333333  0.00000000       1.000
  0.91666667  0.91666667  0.00000000       1.000
End Kpoints
!
mpirun  -n 16 $WANNIER_exe pwscf
#rm band.dat.gnu
ln -s ../../08bands/band.dat.gnu .
cp ../plotband_dft_wannier.py .
python plotband_dft_wannier.py
mv *.png ../fig_$i.png
cd ../
done

